openapi: 3.0.3
info:
  title: MBapp API
  version: '2025-09-25'
  description: Single-source-of-truth API for MBapp objects, views, workspaces, and tools.
  license:
    url: https://license.mbapp.dev
    name: MIT
servers:
- url: https://api.mbapp.dev
tags:
- name: Objects
  description: Generic object CRUD, list, search, and actions by type.
- name: Auth
  description: |
    Authentication and policy.
    JWT includes `mbapp` claim object with:
      - `mbapp.userId` (string)
      - `mbapp.tenantId` (string)
      - `mbapp.roles` (string array)
      - `mbapp.policy` (Record<string, boolean>)
    Policy precedence:
      - if `mbapp.policy` is present and non-empty, use it as-is
      - else derive permissions from `mbapp.roles`
      - else policy is empty
    Permission keys:
      - keys are lowercase
      - wildcard semantics supported: `*`, `*:*`, `*:read`, `{type}:*`
    Compatibility: server expands legacy aliases for party/parties, product/products, sales/salesorder, purchase/purchaseorder, and inventory/inventoryitem.
- name: Views
  description: Saved per-module user views (filters/sorts/columns).
- name: Workspaces
  description: Role-aware cross-module compositions (tiles).
- name: Tools
  description: Dev/ops helpers for non-prod use.
- name: Admin
  description: Administrative and audit endpoints.
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    IdempotencyKey:
      in: header
      name: Idempotency-Key
      required: false
      schema:
        type: string
      description: Optional idempotency key for safe retries.
    TenantHeader:
      name: x-tenant-id
      in: header
      required: true
      schema:
        type: string
    TypePath:
      name: type
      in: path
      required: true
      schema:
        type: string
    IdPath:
      name: id
      in: path
      required: true
      schema:
        type: string
    Limit:
      name: limit
      in: query
      schema:
        type: integer
        format: int32
        minimum: 1
        maximum: 200
        default: 25
      description: Maximum number of items to return
    Next:
      name: next
      in: query
      schema:
        type: string
    Q:
      name: q
      in: query
      schema:
        type: string
      description: Optional substring search filter
    Cursor:
      name: next
      in: query
      schema:
        type: string
      description: Opaque pagination cursor for next page
    EntityType:
      name: entityType
      in: query
      schema:
        type: string
        enum:
        - purchaseOrder
        - salesOrder
        - inventoryItem
        - party
        - account
        - event
        - employee
        - organization
        - product
        - class
        - division
      description: Filter by entity/object type
    Fields:
      name: fields
      in: query
      schema:
        type: string
        description: Comma-separated field projection
  responses:
    ErrorResponse:
      description: Error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    ValidationErrorResponse:
      description: Validation error response
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationError'
    ListPage:
      description: Paged list of objects
      content:
        application/json:
          schema:
            type: object
            properties:
              items:
                type: array
                items:
                  $ref: '#/components/schemas/AnyObject'
              next:
                type: string
                nullable: true
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
    Unauthorized:
      description: Unauthorized
    Forbidden:
      description: Forbidden
    NotFound:
      description: Not found
  schemas:
    Error:
      type: object
      required:
      - code
      - message
      properties:
        code:
          type: string
          description: Machine-readable error code
        message:
          type: string
          description: Human-readable error message
        details:
          type: object
          additionalProperties: true
          description: Optional additional context
    ValidationError:
      allOf:
      - $ref: '#/components/schemas/Error'
      - type: object
        properties:
          fieldErrors:
            type: array
            description: Field-specific validation errors
            items:
              type: object
              required:
              - field
              - message
              properties:
                field:
                  type: string
                  description: Field name or path
                message:
                  type: string
                  description: Validation error message
                code:
                  type: string
                  description: Error code for this field
    Account:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - account
          name:
            type: string
            minLength: 1
          number:
            type: string
            minLength: 1
          currency:
            type: string
            pattern: ^[A-Z]{3}$
            default: USD
          accountType:
            type: string
            description: e.g., asset, liability, revenue, expense, equity
            enum:
            - asset
            - liability
            - revenue
            - expense
            - equity
          balance:
            type: number
            description: Current balance (display only)
            readOnly: true
          status:
            type: string
            enum:
            - active
            - inactive
            - archived
            default: active
    Address:
      type: object
      properties:
        address1:
          type: string
        address2:
          type: string
          nullable: true
        city:
          type: string
          nullable: true
        state:
          type: string
          nullable: true
        postal:
          type: string
          nullable: true
        country:
          type: string
          nullable: true
    AnyObject:
      type: object
      additionalProperties: true
      properties: {}
    BackorderRequest:
      type: object
      required: [id, type, soId, soLineId, itemId, qty, createdAt, status]
      properties:
        id:          { type: string }
        type:        { type: string, enum: [backorderRequest] }
        preferredVendorId: { type: string, nullable: true, description: 'Optional denormalized vendor preference for UI filtering' }
        soId:        { type: string }
        soLineId:    { type: string }
        itemId:      { type: string }
        qty:         { type: number }
        fulfilledQty: { type: number, nullable: true, description: 'Server-maintained qty fulfilled via PO receive' }
        remainingQty: { type: number, nullable: true, description: 'Server-maintained remaining qty to fulfill' }
        createdAt:   { type: string, format: date-time }
        status:      { type: string, enum: [open, ignored, converted, fulfilled], default: open }
    Class:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - class
          divisionId:
            type: string
            nullable: true
          code:
            type: string
          name:
            type: string
          description:
            type: string
            nullable: true
          fee:
            type: number
            nullable: true
          order:
            type: integer
            nullable: true
          rules:
            type: array
            items:
              type: string
            nullable: true
          notes:
            type: string
            nullable: true
    CustomerAccount:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - customerAccount
          partyId:
            type: string
          termsId:
            type: string
            nullable: true
          creditLimit:
            type: number
            nullable: true
          priceListId:
            type: string
            nullable: true
          taxExempt:
            type: boolean
            default: false
          defaultBillToId:
            type: string
            nullable: true
          defaultShipToId:
            type: string
            nullable: true
        required:
        - partyId
    Division:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - division
          code:
            type: string
          name:
            type: string
          description:
            type: string
            nullable: true
          fee:
            type: number
            nullable: true
          rules:
            type: array
            items:
              type: string
            nullable: true
          notes:
            type: string
            nullable: true
    Employee:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - employee
          name:
            type: string
            minLength: 1
          displayName:
            type: string
          email:
            type: string
            format: email
          phone:
            type: string
          role:
            type: string
          status:
            type: string
            enum:
            - active
            - inactive
            - terminated
            default: active
          hiredAt:
            type: string
            format: date-time
          startDate:
            type: string
            format: date-time
            description: Alias of hiredAt for UI consistency
          terminatedAt:
            type: string
            format: date-time
          notes:
            type: string
    EpcBinding:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - epcBinding
          epc:
            type: string
          itemId:
            type: string
          locationId:
            type: string
          lot:
            type: string
            nullable: true
          state:
            type: string
            enum:
            - active
            - retired
            default: active
        required:
        - type
        - epc
        - itemId
    EPCMap:
      type: object
      required:
      - id
      - type
      - epc
      - itemId
      properties:
        id:
          type: string
          description: Use EPC string as id
        type:
          type: string
          enum:
          - epcMap
          default: epcMap
        epc:
          type: string
        itemId:
          type: string
        lotId:
          type: string
          nullable: true
        locationId:
          type: string
          nullable: true
        status:
          type: string
          enum:
          - active
          - retired
          default: active
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    Event:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - event
          name:
            type: string
          description:
            type: string
          location:
            type: string
          startsAt:
            type: string
            format: date-time
          endsAt:
            type: string
            format: date-time
          start:
            type: string
            format: date-time
            description: Alias of startsAt (deprecated)
          end:
            type: string
            format: date-time
            description: Alias of endsAt (deprecated)
          status:
            type: string
            default: draft
            enum:
            - draft
            - scheduled
            - open
            - closed
            - completed
            - cancelled
            - archived
          capacity:
            type: number
            minimum: 0
          rvEnabled:
            type: boolean
            description: Enable RV add-on booking for this event (Sprint BG)
            default: false
          rvCapacity:
            type: integer
            minimum: 0
            description: RV spots available for this event (0 means none)
          rvUnitAmount:
            type: integer
            minimum: 0
            description: Price in cents per RV spot for this event
          stallEnabled:
            type: boolean
            description: Enable stall reservation for this event (Sprint BK)
            default: false
          stallCapacity:
            type: integer
            minimum: 0
            nullable: true
            description: Stall slots available for this event (0 means none, null means unlimited)
          stallUnitAmount:
            type: integer
            minimum: 0
            nullable: true
            description: Price in cents per stall for this event (optional)
          notes:
            type: string
          lines:
            type: array
            items:
              $ref: '#/components/schemas/EventLine'
        required:
        - type
        - name
        - startsAt
    EventLine:
      type: object
      properties:
        id:
          type: string
        classId:
          type: string
        capacity:
          type: number
          nullable: true
        fee:
          type: number
          nullable: true
        note:
          type: string
          nullable: true
      required:
      - classId
    GoodsReceipt:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - poId
        - ts
        - lines
        properties:
          id:
            type: string
          type:
            type: string
            enum:
            - goodsReceipt
          tenantId:
            type: string
          poId:
            type: string
          userId:
            type: string
            nullable: true
          ts:
            type: string
            format: date-time
            nullable: true
          lines:
            type: array
            items:
              type: object
              required:
              - id
              - deltaQty
              properties:
                id:
                  type: string
                  description: Canonical line id (preferred). Server-assigned `L{n}` pattern.
                lineId:
                  type: string
                  nullable: true
                  deprecated: true
                  description: Alias for `id` (compatibility; will be removed after transition).
                itemId:
                  type: string
                  nullable: true
                deltaQty:
                  type: number
                lot:
                  type: string
                  nullable: true
                locationId:
                  type: string
                  nullable: true
          notes:
            type: string
            nullable: true
          attachments:
            type: array
            items:
              type: string
    GoodsReceiptLine:
      type: object
      required:
      - id
      - deltaQty
      properties:
        id:
          type: string
          description: Canonical line id (preferred). Server-assigned `L{n}` pattern.
        lineId:
          type: string
          nullable: true
          deprecated: true
          description: Alias for `id` (compatibility; will be removed after transition).
        deltaQty:
          type: number
        locationId:
          type: string
          nullable: true
        lot:
          type: string
          nullable: true
    Integration:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - integration
          provider:
            type: string
            enum:
            - shopify
            - quickbooks
            - rfid
            - webhook
            - streaming
          status:
            type: string
            enum:
            - disabled
            - enabled
          config:
            type: object
            additionalProperties: true
        required:
        - type
        - provider
        - status
    IntegrationRun:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - integrationRun
          integrationId:
            type: string
          startedAt:
            type: string
            format: date-time
          finishedAt:
            type: string
            format: date-time
            nullable: true
          status:
            type: string
            enum:
            - queued
            - running
            - success
            - error
          stats:
            type: object
            additionalProperties: true
          error:
            type: string
            nullable: true
        required:
        - type
        - integrationId
        - startedAt
        - status
    InventoryAdjustmentRequest:
      type: object
      required:
      - deltaQty
      properties:
        deltaQty:
          type: number
          description: Quantity adjustment (positive to add, negative to subtract)
        reason:
          type: string
          nullable: true
          description: Reason for adjustment (legacy field, use note instead)
          minLength: 1
        note:
          type: string
          nullable: true
          description: Note or reason for the adjustment
        notes:
          type: string
          nullable: true
          description: Alias for note (both are accepted for backwards compatibility)
    PutawayRequest:
      type: object
      required:
      - qty
      - toLocationId
      properties:
        qty:
          type: number
          minimum: 0
          exclusiveMinimum: true
          description: Quantity to putaway (must be > 0)
        toLocationId:
          type: string
          description: Target location id
        fromLocationId:
          type: string
          nullable: true
          description: Source location id (optional audit trail)
        lot:
          type: string
          nullable: true
          description: Lot identifier (optional)
        note:
          type: string
          nullable: true
          description: Optional note for the putaway movement
    CycleCountRequest:
      type: object
      required:
      - countedQty
      properties:
        countedQty:
          type: number
          minimum: 0
          description: Physical count quantity (non-negative)
        locationId:
          type: string
          nullable: true
          description: Location where count was performed (optional)
        lot:
          type: string
          nullable: true
          description: Lot identifier (optional)
        note:
          type: string
          nullable: true
          description: Optional note for the cycle count movement
    InventoryItem:
      description: |
        Canonical inventory object (type=inventoryItem). Legacy records may be stored with type=inventory; server treats inventory and inventoryItem as aliases for backward compatibility.
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - inventoryItem
          productId:
            type: string
            nullable: true
          name:
            type: string
          sku:
            type: string
          quantity:
            type: number
            description: "Deprecated \u2013 use /inventory/{id}/onhand"
            deprecated: true
          uom:
            type: string
          location:
            type: string
            nullable: true
          minQty:
            type: number
            minimum: 0
            nullable: true
          maxQty:
            type: number
            minimum: 0
            nullable: true
          status:
            type: string
            enum:
            - active
            - inactive
            - archived
            default: active
          notes:
            type: string
            nullable: true
          lotTracked:
            type: boolean
            default: false
          barcode:
            type: string
            nullable: true
          tags:
            type: array
            items:
              type: string
    InventoryMovement:
      type: object
      required:
      - id
      - itemId
      - action
      - qty
      properties:
        id:
          type: string
        itemId:
          type: string
        action:
          type: string
          enum:
          - receive
          - reserve
          - commit
          - fulfill
          - adjust
          - release
          - putaway
          - cycle_count
        qty:
          type: number
        at:
          type: string
          format: date-time
        note:
          type: string
          nullable: true
        actorId:
          type: string
          nullable: true
        refId:
          type: string
          description: Source document id (e.g., purchaseOrder id)
          nullable: true
        poLineId:
          type: string
          description: Optional purchase order line id (when action is from a PO)
          nullable: true
        soId:
          type: string
          description: Optional sales order id (when action is from an SO, e.g., reserve/commit/release/fulfill)
          nullable: true
        soLineId:
          type: string
          description: Optional sales order line id (when action is from an SO line)
          nullable: true
        uom:
          type: string
          nullable: true
        lot:
          type: string
          nullable: true
        locationId:
          type: string
          nullable: true
        docType:
          type: string
          readOnly: true
          enum:
          - inventoryMovement
    InventoryOnHand:
      type: object
      required:
      - id
      - qtyOnHand
      properties:
        id:
          type: string
        qtyOnHand:
          type: number
          minimum: 0
        qtyAvailable:
          type: number
          minimum: 0
          nullable: true
        asOf:
          type: string
          format: date-time
      deprecated: true
      description: "Deprecated \u2013 use InventoryCounters & GET /inventory/{id}/onhand"
    ListPageInventoryMovement:
      type: object
      required:
      - itemId
      - items
      properties:
        itemId:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/InventoryMovement'
        next:
          type: string
          nullable: true
          description: Opaque cursor for next page (if any)
        pageInfo:
          description: Optional pagination metadata (clients may ignore).
          type: object
          properties:
            hasNext:
              type: boolean
            nextCursor:
              type: string
              nullable: true
            pageSize:
              type: integer
    ListMovementsByLocationResponse:
      type: object
      required:
      - items
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/InventoryMovement'
        next:
          type: string
          nullable: true
          description: Opaque cursor for next page (if any)
    Message:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - channel
        - body
        properties:
          type:
            type: string
            enum:
            - message
          channel:
            type: string
            enum:
            - push
            - sms
            - email
          subject:
            type: string
            nullable: true
          body:
            type: string
          to:
            type: string
            nullable: true
            description: Recipient address for email/sms channels; optional for segmented push
          segment:
            type: object
            additionalProperties: true
            nullable: true
          scheduleAt:
            type: string
            format: date-time
            nullable: true
          sentAt:
            type: string
            format: date-time
            nullable: true
          lastAttemptAt:
            type: string
            format: date-time
            nullable: true
            description: Timestamp of last send attempt
          status:
            type: string
            enum:
            - queued
            - sending
            - sent
            - failed
            - cancelled
            default: queued
          provider:
            type: string
            nullable: true
            description: Email provider name (e.g., "postmark", "sendgrid")
          providerMessageId:
            type: string
            nullable: true
            description: Provider-assigned message identifier (e.g., Postmark MessageID)
          errorMessage:
            type: string
            nullable: true
            description: Last provider error message if status is failed
          retryCount:
            type: integer
            nullable: true
            description: Number of retry attempts after failures
          templateKey:
            type: string
            nullable: true
            description: Template identifier for rendering subject/body (Sprint BA)
          templateVars:
            type: object
            additionalProperties: true
            nullable: true
            description: Variables for template rendering (Sprint BA)
          queuedAt:
            type: string
            format: date-time
            nullable: true
            description: Timestamp when message was queued
          metadata:
            type: object
            additionalProperties: true
            nullable: true
            description: Additional metadata (e.g., registrationId, paymentIntentId)
          notes:
            type: string
            nullable: true
    MessageRetryResult:
      type: object
      description: Summary of a message after a retry attempt
      required:
      - id
      - status
      properties:
        id:
          type: string
        status:
          type: string
        retryCount:
          type: integer
          nullable: true
        lastAttemptAt:
          type: string
          format: date-time
          nullable: true
        sentAt:
          type: string
          format: date-time
          nullable: true
        provider:
          type: string
          nullable: true
        errorMessage:
          type: string
          nullable: true
    MoneyTotals:
      type: object
      properties:
        subtotal: { type: number }
        tax:      { type: number }
        shipping: { type: number }
        discount: { type: number }
        total:    { type: number }
    ObjectBase:
      type: object
      properties:
        id:        { type: string, readOnly: true }
        tenantId:  { type: string, readOnly: true }
        type:      { type: string }
        createdAt: { type: string, format: date-time, readOnly: true }
        updatedAt: { type: string, format: date-time, readOnly: true }
        metadata:  { type: object, additionalProperties: true }
      required: [id, tenantId, createdAt, updatedAt]
    ReservationHold:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        description: Ledger object for count-based holds/confirmations (e.g., event seats, RV spots).
        required:
        - type
        - ownerType
        - ownerId
        - scopeType
        - scopeId
        - itemType
        - qty
        - state
        - heldAt
        properties:
          type:
            type: string
            enum: [reservationHold]
          ownerType:
            type: string
            description: Owning entity type for the hold (e.g., registration)
            enum: [registration]
          ownerId:
            type: string
          scopeType:
            type: string
            description: Scope type for the resource being reserved (e.g., event)
            enum: [event]
          scopeId:
            type: string
            description: Scope ID (e.g., eventId)
          itemType:
            type: string
            description: Reserved item kind within the scope
            enum: [seat, rv, stall]
          qty:
            type: number
            minimum: 1
          state:
            type: string
            enum: [held, confirmed, released, cancelled]
            description: Current state of the reservation hold
          heldAt:
            type: string
            format: date-time
          expiresAt:
            type: string
            format: date-time
            nullable: true
          confirmedAt:
            type: string
            format: date-time
            nullable: true
          releasedAt:
            type: string
            format: date-time
            nullable: true
          releaseReason:
            type: string
            nullable: true
            description: Optional freeform reason for release/cancel (v1; consider enum later)
          resourceId:
            type: string
            nullable: true
            description: Optional specific resource ID (e.g., EventResource stall ID). When null, refers to a pool/block of resources (Sprint BK).
          groupId:
            type: string
            nullable: true
            description: Optional grouping ID (e.g., barn/row/section). Can also be stored in metadata (Sprint BK).
          metadata:
            type: object
            additionalProperties: true
            nullable: true
    Organization:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - organization
          name:
            type: string
          kind:
            type: string
            enum:
            - club
            - federation
            - venueOp
            - sponsor
            example: federation
          status:
            type: string
            enum:
            - active
            - inactive
            - archived
            default: active
          notes:
            type: string
            nullable: true
          metadata:
            type: object
            additionalProperties: true
            nullable: true
          code:
            type: string
            nullable: true
          website:
            type: string
            format: uri
            nullable: true
          phone:
            type: string
            nullable: true
          email:
            type: string
            format: email
            nullable: true
          address:
            type: string
            nullable: true
          prefs:
            type: object
            additionalProperties: true
            nullable: true
    Party:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - kind
        - displayName
        - status
        properties:
          type:
            type: string
            enum:
            - party
          kind:
            type: string
            enum:
            - person
            - organization
            - animal
          displayName:
            type: string
          firstName:
            type: string
          lastName:
            type: string
          email:
            type: string
            format: email
          phone:
            type: string
          addresses:
            type: array
            items:
              $ref: '#/components/schemas/Address'
          tags:
            type: array
            items:
              type: string
          status:
            type: string
            enum:
            - active
            - inactive
            - archived
            default: active
          notes:
            type: string
          roles:
            type: array
            items:
              type: string
            description: Canonical role membership (customer, vendor, employee, etc.). Used for party role enforcement.
    PartyLink:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - aPartyId
        - bPartyId
        - kind
        properties:
          type:
            type: string
            enum:
            - partyLink
          aPartyId:
            type: string
          bPartyId:
            type: string
          kind:
            type: string
            enum:
            - employs
            - member_of
            - owns
            - handles
            - parent
            - affiliate
          startsAt:
            type: string
            format: date-time
          endsAt:
            type: string
            format: date-time
          notes:
            type: string
    Policy:
      type: object
      description: "Permission map; keys are permission strings (e.g., 'product:read', 'inventory:write'); values are boolean (true if granted). Supports wildcard patterns: '*' (superuser), '*:*' (all actions), '*:read' (read all), 'product:*' (all product actions)."
      additionalProperties:
        type: boolean
    Product:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - product
          name:
            type: string
          kind:
            type: string
            enum:
            - good
            - service
            default: good
          sku:
            type: string
          price:
            type: number
            minimum: 0
            nullable: true
          reorderEnabled:
            type: boolean
            description: "If false, never auto-suggest PO for shortages."
            default: true
          preferredVendorId:
            type: string
            nullable: true
          minOrderQty:
            type: number
            nullable: true
          leadTimeDays:
            type: number
            nullable: true
          taxCode:
            type: string
            nullable: true
          status:
            type: string
            enum:
            - active
            - inactive
            - archived
            default: active
          notes:
            type: string
            nullable: true
          defaultItemId:
            type: string
            nullable: true
          tags:
            type: array
            items:
              type: string
    PurchaseOrderLine:
      type: object
      required: [itemId, qty, uom]
      properties:
        id:          { type: string, description: "Server-assigned on create; included in responses" }
        itemId:      { type: string, description: InventoryItem.id }
        productId:   { type: string, nullable: true }
        description: { type: string, nullable: true }
        uom:         { type: string }
        qty:         { type: number, minimum: 0, description: Ordered quantity }
        qtyRequested: { type: number, nullable: true, description: "Original requested qty (pre-adjustment)" }
        qtySuggested: { type: number, nullable: true, description: "Suggested qty after MOQ adjustments" }
        adjustedFrom: { type: number, nullable: true, description: "When MOQ applied, original requested qty" }
        minOrderQtyApplied: { type: number, nullable: true, description: "Applied MOQ when suggestion bumps qty" }
        qtyReceived: { type: number, default: 0 }   # server-computed
        unitPrice:   { type: number, nullable: true }
        taxRate:     { type: number, nullable: true }
        lineTotal:   { type: number, nullable: true }
        locationId:  { type: string, nullable: true }
        lot:         { type: string, nullable: true }
        expectedDate: { type: string, format: date-time, nullable: true }
        backorderRequestIds: { type: array, items: { type: string }, nullable: true, description: "BackorderRequest ids this PO line is intended to fulfill" }

    PurchaseOrder:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required: [type, vendorId, status]
        properties:
          type:          { type: string, enum: [purchaseOrder] }
          vendorAccountId: { type: string }
          vendorId:      { type: string }     # canonical
          vendorName:    { type: string }
          partyId:       { type: string }     # optional alias if you wire parties generically
          partyKind:     { type: string, enum: [person, organization, animal] }
          orderNumber:   { type: string }
          status:
            type: string
            enum: [draft, submitted, approved, partially-received, fulfilled, cancelled, closed]
          currency:      { type: string, default: USD }
          notes:         { type: string }
          totals:        { $ref: '#/components/schemas/MoneyTotals' }
          shipTo:
            type: object
            properties:
              name:    { type: string }
              address1: { type: string }
              address2: { type: string }
              city:    { type: string }
              state:   { type: string }
              postal:  { type: string }
              country: { type: string }
          billTo:
            type: object
            properties:
              name:    { type: string }
              address1: { type: string }
              address2: { type: string }
              city:    { type: string }
              state:   { type: string }
              postal:  { type: string }
              country: { type: string }
          lines:
            type: array
            items: { $ref: '#/components/schemas/PurchaseOrderLine' }
    SuggestPoResponse:
      description: Single vendor returns `draft`; multi-vendor returns `drafts`. Always includes skipped entries for ignored/invalid requests.
      allOf:
        - type: object
          properties:
            skipped:
              type: array
              items:
                type: object
                required: [backorderRequestId, reason]
                properties:
                  backorderRequestId: { type: string }
                  reason:
                    type: string
                    enum: [ZERO_QTY, MISSING_VENDOR, IGNORED, NOT_FOUND]
        - anyOf:
            - type: object
              required: [draft]
              properties:
                draft:
                  $ref: '#/components/schemas/PurchaseOrder'
            - type: object
              required: [drafts]
              properties:
                drafts:
                  type: array
                  items: { $ref: '#/components/schemas/PurchaseOrder' }

    PurchaseOrderReceiveRequest:
      type: object
      required: [lines]
      properties:
        idempotencyKey: { type: string, deprecated: true }
        lines:
          type: array
          minItems: 1
          items:
            type: object
            required: [id, deltaQty]
            properties:
              id:         { type: string, description: "Canonical line id (preferred). Server-assigned `L{n}` pattern." }
              lineId:     { type: string, nullable: true, deprecated: true, description: "Alias for id (compatibility; will be removed after transition)." }
              deltaQty:   { type: number, minimum: 1 }
              locationId: { type: string }
              lot:        { type: string }
    Registration:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - registration
          eventId:
            type: string
            description: ID of the event this registration is for
          partyId:
            type: string
            description: ID of the party (person/org) being registered
          status:
            type: string
            default: draft
            enum:
            - draft
            - submitted
            - confirmed
            - cancelled
            description: |
              Registration status (Sprint IV v1).
              - submitted = hold active until holdExpiresAt (seat reserved, payment pending)
              - confirmed = payment succeeded; seat retained
              - cancelled = hold expired or explicitly cancelled
          division:
            type: string
            nullable: true
            description: Division or category (optional)
          class:
            type: string
            nullable: true
            description: Class or level (optional)
          fees:
            type: array
            nullable: true
            description: Registration fee line items (server-owned after checkout)
            items:
              $ref: '#/components/schemas/FeeLineItem'
          rvQty:
            type: integer
            minimum: 0
            description: Number of RV spots requested for this registration (server-stored)
          stallQty:
            type: integer
            minimum: 0
            nullable: true
            description: Number of stalls requested for this registration (Sprint BK; server-stored)
          notes:
            type: string
            nullable: true
            description: Additional notes
          paymentIntentId:
            type: string
            nullable: true
            description: Stripe PaymentIntent ID (Sprint AU)
          paymentStatus:
            type: string
            nullable: true
            enum:
            - pending
            - paid
            - failed
            - refunded
            description: Payment status
          totalAmount:
            type: integer
            nullable: true
            description: Total amount in cents for this registration (server-computed)
          currency:
            type: string
            nullable: true
            description: ISO currency code for totals (e.g., "usd")
          submittedAt:
            type: string
            format: date-time
            nullable: true
            description: Timestamp when status changed to submitted (Sprint AU)
          confirmedAt:
            type: string
            format: date-time
            nullable: true
            description: Timestamp when status changed to confirmed (Sprint AU)
          cancelledAt:
            type: string
            format: date-time
            nullable: true
            description: Timestamp when status changed to cancelled (operator or TTL expiry)
          refundedAt:
            type: string
            format: date-time
            nullable: true
            description: Timestamp when payment was refunded (operator action)
          refundId:
            type: string
            nullable: true
            description: Provider refund id (server-only; never included in public response)
          holdExpiresAt:
            type: string
            format: date-time
            nullable: true
            description: When a submitted hold should expire and be cancelled; null means no TTL
          publicTokenHash:
            type: string
            nullable: true
            description: Server-side hash of public token for guest checkout (Sprint AU)
          confirmationSmsMessageId:
            type: string
            nullable: true
            description: Message object ID created for SMS confirmation (Sprint AX)
          clientId:
            type: string
            nullable: true
            description: Legacy field (use partyId instead)
          clientName:
            type: string
            nullable: true
            description: Legacy field
          qty:
            type: number
            default: 1
            minimum: 1
            nullable: true
            description: Legacy field
          startsAt:
            type: string
            format: date-time
            nullable: true
            description: Legacy field
          endsAt:
            type: string
            format: date-time
            nullable: true
            description: Legacy field
          start:
            type: string
            format: date-time
            description: Legacy alias of startsAt (deprecated)
            nullable: true
          end:
            type: string
            format: date-time
            description: Legacy alias of endsAt (deprecated)
            nullable: true
          registeredAt:
            type: string
            format: date-time
            nullable: true
            description: Legacy field
          partyKind:
            type: string
            enum:
            - person
            - organization
            - animal
            nullable: true
            description: Legacy field
          lines:
            type: array
            nullable: true
            description: Legacy field (line items)
            items:
              $ref: '#/components/schemas/RegistrationLine'
        required:
        - type
        - eventId
        - partyId
    PublicRegistrationStatusResponse:
      type: object
      description: Public-safe registration status snapshot (no PII/financials)
      properties:
        id:
          type: string
        eventId:
          type: string
        status:
          type: string
          enum: [draft, submitted, confirmed, cancelled]
        paymentStatus:
          type: string
          nullable: true
          enum: [pending, paid, failed, refunded]
        totalAmount:
          type: integer
          nullable: true
          description: Safe total amount in cents (if exposed)
        currency:
          type: string
          nullable: true
          description: ISO currency code (e.g., "usd")
        fees:
          type: array
          nullable: true
          description: Safe projection of fee line items (no PII)
          items:
            $ref: '#/components/schemas/FeeLineItem'
        submittedAt:
          type: string
          format: date-time
          nullable: true
        confirmedAt:
          type: string
          format: date-time
          nullable: true
        cancelledAt:
          type: string
          format: date-time
          nullable: true
        refundedAt:
          type: string
          format: date-time
          nullable: true
        holdExpiresAt:
          type: string
          format: date-time
          nullable: true
        emailStatus:
          type: object
          nullable: true
          properties:
            status:
              type: string
              enum: [queued, sending, sent, failed, cancelled]
            sentAt:
              type: string
              format: date-time
              nullable: true
            provider:
              type: string
              nullable: true
            errorMessage:
              type: string
              nullable: true
    PublicRegistrationResendResponse:
      type: object
      description: Result of public resend request (confirmation email/SMS)
      required:
      - registrationId
      properties:
        registrationId:
          type: string
        email:
          type: object
          nullable: true
          properties:
            status:
              type: string
              enum: [queued, sending, sent, failed, cancelled]
            sentAt:
              type: string
              format: date-time
              nullable: true
            provider:
              type: string
              nullable: true
            errorMessage:
              type: string
              nullable: true
    RefundResult:
      type: object
      description: Minimal refund information (non-sensitive)
      properties:
        id:
          type: string
          description: Provider refund id
        amount:
          type: integer
          nullable: true
          description: Refunded amount in cents (if available)
        currency:
          type: string
          nullable: true
          description: ISO currency code
        provider:
          type: string
          nullable: true
          description: Payment provider key (e.g., stripe)
    CancelRefundResponse:
      type: object
      description: Response for cancel-refund action
      properties:
        registration:
          $ref: '#/components/schemas/Registration'
        refund:
          allOf:
          - $ref: '#/components/schemas/RefundResult'
          - type: object
            nullable: true
        sms:
          type: object
          nullable: true
          properties:
            status:
              type: string
              enum: [queued, sending, sent, failed, cancelled]
            sentAt:
              type: string
              format: date-time
              nullable: true
            provider:
              type: string
              nullable: true
            errorMessage:
              type: string
              nullable: true
        rateLimited:
          type: boolean
          description: True when server skipped enqueue due to rate limit/bounds
        attempted:
          type: object
          nullable: true
          properties:
            email:
              type: boolean
              description: Whether an email resend was attempted
            sms:
              type: boolean
              description: Whether an SMS resend was attempted
        smsStatus:
          type: object
          nullable: true
          properties:
            status:
              type: string
              enum: [queued, sending, sent, failed, cancelled]
            sentAt:
              type: string
              format: date-time
              nullable: true
            provider:
              type: string
              nullable: true
            errorMessage:
              type: string
              nullable: true
    AssignStallsRequest:
      type: object
      description: Request to assign specific stalls to a registration (Sprint BK)
      required:
      - stallIds
      properties:
        stallIds:
          type: array
          description: List of EventResource IDs (stalls) to assign
          items:
            type: string
          minItems: 1
    AssignStallsResponse:
      type: object
      description: Response from assign-stalls action
      properties:
        holds:
          type: array
          description: Updated or created ReservationHold objects for assigned stalls
          items:
            $ref: '#/components/schemas/ReservationHold'
    AssignRvSitesRequest:
      type: object
      description: Request to assign specific RV site resources to a registration (Sprint BL)
      required:
      - rvSiteIds
      properties:
        rvSiteIds:
          type: array
          description: List of EventResource IDs (RV sites) to assign
          items:
            type: string
          minItems: 1
    AssignRvSitesResponse:
      type: object
      description: Response from assign-rv-sites action
      properties:
        holds:
          type: array
          description: Updated or created ReservationHold objects for assigned RV sites
          items:
            $ref: '#/components/schemas/ReservationHold'
    AssignResourcesRequest:
      type: object
      description: Request to assign specific discrete resources to a registration (Sprint BM)
      required:
      - itemType
      - resourceIds
      properties:
        itemType:
          type: string
          enum:
          - stall
          - rv
          description: Type of resource being assigned (extensible for future types like vip-suite, equipment)
        resourceIds:
          type: array
          description: List of resource IDs to assign
          items:
            type: string
          minItems: 1
    AssignResourcesResponse:
      type: object
      description: Response from assign-resources action
      properties:
        holds:
          type: array
          description: Created or updated ReservationHold objects for assigned resources
          items:
            $ref: '#/components/schemas/ReservationHold'
        count:
          type: integer
          description: Number of holds in response
    RegistrationLine:
      type: object
      properties:
        id:
          type: string
        classId:
          type: string
        qty:
          type: number
          default: 1
          minimum: 1
        note:
          type: string
          nullable: true
      required:
      - classId
      - qty
    PaymentIntentResponse:
      type: object
      description: Response from checkout endpoint containing Stripe PaymentIntent details (Sprint AU)
      required:
      - paymentIntentId
      - clientSecret
      properties:
        paymentIntentId:
          type: string
          description: Stripe PaymentIntent ID
        clientSecret:
          type: string
          description: Client secret for Stripe.js to confirm payment
        totalAmount:
          type: integer
          nullable: true
          description: Total amount in cents for the PaymentIntent (server-computed)
        currency:
          type: string
          nullable: true
          description: ISO currency code (e.g., "usd")
    PublicRegistrationRequest:
      type: object
      description: Request body for public registration creation (Sprint AU)
      required:
      - eventId
      properties:
        eventId:
          type: string
          description: ID of the event to register for
        party:
          type: object
          nullable: true
          description: Guest party information (for anonymous users)
          properties:
            name:
              type: string
              nullable: true
            email:
              type: string
              nullable: true
            phone:
              type: string
              nullable: true
              description: Phone number for SMS confirmation (optional)
        fees:
          type: array
          nullable: true
          description: Registration fees
          items:
            type: object
            required: [code, amount]
            properties:
              code:
                type: string
              amount:
                type: number
              description:
                type: string
                nullable: true
        rvQty:
          type: integer
          minimum: 0
          maximum: 10
          default: 0
          description: Optional number of RV spots requested (pricing is server-computed; client may not submit amounts)
        division:
          type: string
          nullable: true
        class:
          type: string
          nullable: true
        notes:
          type: string
          nullable: true
    FeeLineItem:
      type: object
      description: Server-owned fee line item used to compute totals
      required: [key, label, qty, unitAmount, amount, currency]
      properties:
        key:
          type: string
          description: Machine key (e.g., "rv")
        label:
          type: string
          description: Human label (e.g., "RV Spot")
        qty:
          type: integer
          minimum: 0
        unitAmount:
          type: integer
          minimum: 0
          description: Unit price in cents
        amount:
          type: integer
          minimum: 0
          description: Total amount in cents (qty * unitAmount)
        currency:
          type: string
          description: ISO currency code (e.g., "usd")
    PublicRegistrationResponse:
      type: object
      description: Response from public registration creation including guest token (Sprint AU)
      required:
      - registration
      - publicToken
      properties:
        registration:
          $ref: '#/components/schemas/Registration'
        publicToken:
          type: string
          description: Temporary token for guest to complete checkout (single-use, short TTL)
    Reservation:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - resourceId
        - clientId
        - startsAt
        - endsAt
        properties:
          type:
            type: string
            enum:
            - reservation
          resourceId:
            type: string
          resourceName:
            type: string
            nullable: true
          eventId:
            type: string
            nullable: true
          clientId:
            type: string
          clientName:
            type: string
            nullable: true
          startsAt:
            type: string
            format: date-time
          endsAt:
            type: string
            format: date-time
          start:
            type: string
            format: date-time
            description: Alias of startsAt (deprecated)
          end:
            type: string
            format: date-time
            description: Alias of endsAt (deprecated)
          status:
            type: string
            enum:
            - pending
            - confirmed
            - in_use
            - checked_in
            - completed
            - cancelled
            default: pending
          notes:
            type: string
            nullable: true
          partyId:
            type: string
          partyKind:
            type: string
            enum:
            - person
            - organization
            - animal
          rate:
            type: number
            nullable: true
          price:
            type: number
            nullable: true
          conflictKey:
            type: string
            nullable: true
    Resource:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - resource
          name:
            type: string
          code:
            type: string
            nullable: true
          url:
            type: string
            format: uri
            nullable: true
          expiresAt:
            type: string
            format: date-time
            nullable: true
          resourceType:
            type: string
            enum:
            - stall
            - rv
            - arena
            - equipment
            - other
            default: other
          status:
            type: string
            enum:
            - available
            - unavailable
            - maintenance
            default: available
          capacity:
            type: number
            minimum: 0
            nullable: true
          location:
            type: string
            nullable: true
          tags:
            type: array
            items:
              type: string
          notes:
            type: string
            nullable: true
    SalesFulfillmentLine:
      type: object
      required: [id, deltaQty]
      properties:
        id:         { type: string, description: "Canonical line id (preferred). Server-assigned `L{n}` pattern." }
        lineId:     { type: string, nullable: true, deprecated: true, description: "Alias for id (compatibility; will be removed after transition)." }
        deltaQty:   { type: number, minimum: 1 }
        locationId: { type: string, nullable: true }
        lot:        { type: string, nullable: true }
    SalesFulfillment:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required: [type, soId, ts, lines]
        properties:
          type:     { type: string, enum: [salesFulfillment] }
          soId:     { type: string }
          userId:   { type: string, nullable: true }
          ts:       { type: string, format: date-time }
          lines:
            type: array
            items: { $ref: '#/components/schemas/SalesFulfillmentLine' }
          carrier:     { type: string, nullable: true }
          tracking:    { type: string, nullable: true }
          notes:       { type: string, nullable: true }
          attachments:
            type: array
            items: { type: string }
    SalesOrder:
      description: Sprint XXIX web UI uses /objects/salesOrder for draft create/edit with partyId, optional customerId/notes, and simple line {id,itemId,qty,uom} fields.
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required: [type, partyId, status]
        properties:
          type:          { type: string, enum: [salesOrder] }
          partyId:       { type: string }   # canonical
          customerId:    { type: string }   # legacy alias (optional)
          partyKind:     { type: string, enum: [person, organization, animal] }
          orderNumber:   { type: string }
          customerName:  { type: string }
          status:
            type: string
            enum: [draft, submitted, committed, partially_fulfilled, fulfilled, cancelled, closed]
          currency:      { type: string, default: USD }
          notes:         { type: string }
          totals:        { $ref: '#/components/schemas/MoneyTotals' }
          billTo:
            type: object
            properties:
              name:    { type: string }
              address1: { type: string }
              address2: { type: string }
              city:    { type: string }
              state:   { type: string }
              postal:  { type: string }
              country: { type: string }
          shipTo:
            type: object
            properties:
              name:    { type: string }
              address1: { type: string }
              address2: { type: string }
              city:    { type: string }
              state:   { type: string }
              postal:  { type: string }
              country: { type: string }
          lines:
            type: array
            items: { $ref: '#/components/schemas/SalesOrderLine' }
          backorders:
            type: array
            description: Present when non-strict commit recorded shortages
            items:
              type: object
              properties:
                lineId:      { type: string }
                itemId:      { type: string }
                backordered: { type: number }
    SalesOrderLine:
      type: object
      required: [itemId, qty, uom]
      properties:
        id:            { type: string, description: "Server-assigned on create; included in responses" }
        itemId:        { type: string }
        productId:     { type: string, nullable: true }
        description:   { type: string, nullable: true }
        uom:           { type: string }                # UI treats as non-editable
        qty:           { type: number, minimum: 0 }
        qtyCommitted:  { type: number, default: 0 }    # server-computed
        qtyFulfilled:  { type: number, default: 0 }    # server-computed
        unitPrice:     { type: number, nullable: true }
        taxRate:       { type: number, nullable: true }
        lineTotal:     { type: number, nullable: true }
        locationId:    { type: string, nullable: true }
        lot:           { type: string, nullable: true }

    # Patch-lines (draft edit) utility types
    PatchLinesOp:
      type: object
      description: Minimal patch operation for editing lines in draft orders.
      properties:
        op:
          type: string
          enum: [upsert, remove]
        id:
          type: string
          description: Server-assigned line id (stable). Preferred for matching existing lines. Server may assign ids like `L1`, `L2`, ... and they are preserved.
        cid:
          type: string
          description: Client-side temporary key for new lines before persistence; best-effort match when `id` is absent.
        patch:
          type: object
          description: Partial line fields to merge when op=upsert
      required: [op]
    PatchLinesRequest:
      type: object
      required: [ops]
      properties:
        ops:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/PatchLinesOp'
    ScannerAction:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - scannerAction
          action:
            type: string
            enum:
            - pick
            - receive
            - count
            - move
          epc:
            type: string
            description: EPC as scanned
          itemId:
            type: string
          ts:
            type: string
            format: date-time
          sessionId:
            type: string
          soId:
            type: string
          lineId:
            type: string
          fromLocationId:
            type: string
          toLocationId:
            type: string
          qty:
            type: number
            default: 1
          notes:
            type: string
        required:
        - type
        - action
        - epc
        - itemId
        - ts
    ScannerSession:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - scannerSession
          userId:
            type: string
          workspaceId:
            type: string
          status:
            type: string
            enum:
            - active
            - stopped
          startedAt:
            type: string
            format: date-time
          stoppedAt:
            type: string
            format: date-time
            nullable: true
        required:
        - type
        - userId
        - status
        - startedAt
    SalesOrderReserveRequest:
      type: object
      required: [lines]
      properties:
        lines:
          type: array
          minItems: 1
          items:
            type: object
            required: [id, deltaQty]
            properties:
              id:       { type: string, description: "Canonical line id (preferred). Server-assigned `L{n}` pattern." }
              lineId:   { type: string, nullable: true, deprecated: true, description: "Alias for id (compatibility; will be removed after transition)." }
              deltaQty: { type: number, minimum: 1 }
              locationId: { type: string, nullable: true, description: "Optional: when provided, reservation is applied to the specific location; if omitted, behavior is aggregate/unassigned (legacy)." }
              lot:        { type: string, nullable: true, description: "Optional: lot identifier to associate with the reservation when applicable." }

    SalesOrderReleaseRequest:
      type: object
      required: [lines]
      properties:
        lines:
          type: array
          minItems: 1
          items:
            type: object
            required: [id, deltaQty]
            properties:
              id:       { type: string, description: "Canonical line id (preferred). Server-assigned `L{n}` pattern." }
              lineId:   { type: string, nullable: true, deprecated: true, description: "Alias for id (compatibility; will be removed after transition)." }
              deltaQty: { type: number, minimum: 1 }
              reason:   { type: string }
              locationId: { type: string, nullable: true, description: "Optional: when provided, release is applied to the specific location; if omitted, behavior is aggregate/unassigned (legacy)." }
              lot:        { type: string, nullable: true, description: "Optional: lot identifier; may be ignored for release in current implementation." }

    SalesCommitRequest:
      type: object
      properties:
        strict: { type: boolean, description: 'Same as ?strict=1' }

    SalesCommitResponse:
      allOf:
      - $ref: '#/components/schemas/SalesOrder'
      - type: object
        properties:
          shortages:
            type: array
            description: Present when strict=false and availability is partial
            items:
              type: object
              properties:
                lineId:      { type: string }
                itemId:      { type: string }
                backordered: { type: number }
    Scorecard:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - eventId
        - classId
        properties:
          type:
            type: string
            enum:
            - scorecard
          eventId:
            type: string
          classId:
            type: string
          template:
            type: object
            additionalProperties: true
          entries:
            type: array
            items:
              type: object
            nullable: true
          status:
            type: string
            enum:
            - draft
            - published
            - archived
            default: draft
          notes:
            type: string
            nullable: true
    VendorAccount:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        properties:
          type:
            type: string
            enum:
            - vendorAccount
          partyId:
            type: string
          termsId:
            type: string
            nullable: true
          remitToAddressId:
            type: string
            nullable: true
          is1099:
            type: boolean
            default: false
          defaultExpenseAccount:
            type: string
            nullable: true
          defaultCOGSAccount:
            type: string
            nullable: true
        required:
        - partyId
    Venue:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - venue
          name:
            type: string
          address:
            type: string
            nullable: true
          timezone:
            type: string
            nullable: true
          geo:
            type: object
            properties:
              lat:
                type: number
              lon:
                type: number
            nullable: true
          notes:
            type: string
            nullable: true
    View:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        description: Saved per-module user view with filters, sort, and column configuration. Sprint III v1 supports filters and sort; columns are reserved for future.
        properties:
          type:
            type: string
            enum:
            - view
          name:
            type: string
            minLength: 1
            maxLength: 120
            description: Display name for the view
          entityType:
            type: string
            description: Object type this view applies to (e.g., purchaseOrder, salesOrder, inventoryItem, party)
            enum:
            - purchaseOrder
            - salesOrder
            - inventoryItem
            - party
            - account
            - event
            - employee
            - organization
            - product
            - class
            - division
          filters:
            type: array
            description: Filter expressions (Sprint III v1)
            items:
              $ref: '#/components/schemas/ViewFilter'
          sort:
            $ref: '#/components/schemas/ViewSort'
            description: Optional sort configuration
            nullable: true
          columns:
            type: array
            description: Field names to display (reserved for Sprint IV+)
            items:
              type: string
            nullable: true
          description:
            type: string
            description: Optional notes about the view
            nullable: true
          ownerId:
            type: string
            description: User/party who owns this view (for sharing/permission future work)
            nullable: true
          shared:
            type: boolean
            default: false
            description: Whether view is shared with tenant users
        required:
        - type
        - name
        - entityType
    ViewFilter:
      type: object
      description: Filter expression for View (Sprint III v1). Operator support depends on field type.
      properties:
        field:
          type: string
          description: Object field name (e.g., status, createdAt, vendorId)
        op:
          type: string
          description: Comparison operator
          enum:
          - eq
          - ne
          - lt
          - le
          - gt
          - ge
          - in
          - nin
          - contains
          - startsWith
          - regex
        value:
          description: Filter value (type depends on field and operator)
          oneOf:
          - type: string
          - type: number
          - type: boolean
          - type: array
      required:
      - field
      - op
      - value
    ViewSort:
      type: object
      description: Sort order for View results
      properties:
        field:
          type: string
          description: Field name to sort by
        dir:
          type: string
          enum:
          - asc
          - desc
          default: asc
      required:
      - field
    ViewList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/View'
        next:
          type: string
          nullable: true
          description: Opaque cursor for next page (if any)
        pageInfo:
          description: Optional pagination metadata (clients may ignore).
          type: object
          properties:
            hasNext:
              type: boolean
            nextCursor:
              type: string
              nullable: true
            pageSize:
              type: integer
    Workspace:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        description: Minimal workspace definition (Sprint III v1 is "list my views" only). In v1, a Workspace is a response wrapper for Views. Full multi-tile composition deferred to v2.
        properties:
          type:
            type: string
            enum:
            - workspace
          name:
            type: string
            minLength: 1
            maxLength: 200
            description: Workspace name
          entityType:
            type: string
            description: Optional module/object key this workspace targets (aligns to View.entityType)
            enum:
            - purchaseOrder
            - salesOrder
            - inventoryItem
            - party
            - account
            - event
            - employee
            - organization
            - product
            - class
            - division
          description:
            type: string
            description: Optional description
            nullable: true
          views:
            type: array
            description: List of View IDs included in this workspace (Sprint III v1 may be empty; views listed via GET /views)
            items:
              type: string
            default: []
          defaultViewId:
            type: string
            nullable: true
            description: Optional ID of default view to open when workspace is selected. Must be in views[] and entityType-compatible (if workspace.entityType set).
          ownerId:
            type: string
            description: User/party who owns this workspace
            nullable: true
          shared:
            type: boolean
            default: false
            description: Whether workspace is shared with tenant users
        required:
        - type
        - name
    WorkspaceList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Workspace'
        next:
          type: string
          nullable: true
          description: Opaque cursor for next page (if any)
        pageInfo:
          description: Optional pagination metadata (clients may ignore).
          type: object
          properties:
            hasNext:
              type: boolean
            nextCursor:
              type: string
              nullable: true
            pageSize:
              type: integer
    RegistrationList:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Registration'
        next:
          type: string
          nullable: true
          description: Opaque cursor for next page (if any)
        pageInfo:
          description: Optional pagination metadata (clients may ignore).
          type: object
          properties:
            hasNext:
              type: boolean
            nextCursor:
              type: string
              nullable: true
            pageSize:
              type: integer
    WorkspaceTile:
      type: object
      properties:
        moduleKey:
          type: string
        viewId:
          type: string
          nullable: true
        inlineQuery:
          type: object
          additionalProperties: true
          nullable: true
        layout:
          type: object
          additionalProperties: true
      required:
      - moduleKey
    InventoryCounters:
      type: object
      required:
      - itemId
      - onHand
      - reserved
      - available
      properties:
        itemId:
          type: string
        onHand:
          type: number
        reserved:
          type: number
        available:
          type: number
        asOf:
          type: string
          format: date-time
    InventoryOnHandByLocationItem:
      type: object
      required:
      - itemId
      - onHand
      - reserved
      - available
      properties:
        itemId:
          type: string
        locationId:
          type: string
          nullable: true
        onHand:
          type: number
        reserved:
          type: number
        available:
          type: number
        asOf:
          type: string
          format: date-time
    Location:
      allOf:
      - $ref: '#/components/schemas/ObjectBase'
      - type: object
        required:
        - type
        - name
        properties:
          type:
            type: string
            enum:
            - location
          name:
            type: string
          code:
            type: string
            nullable: true
            description: Short code/label for the location
          kind:
            type: string
            nullable: true
            enum:
            - facility
            - warehouse
            - zone
            - aisle
            - rack
            - bin
            - staging
            - dropoff
            - address
            - geo
            - other
            default: facility
          status:
            type: string
            enum:
            - active
            - inactive
            - archived
            default: active
          parentId:
            type: string
            nullable: true
            description: Optional parent location id (hierarchy)
          attributes:
            type: object
            nullable: true
            additionalProperties: true
          notes:
            type: string
            nullable: true
    LocationNode:
      type: object
      required:
      - id
      - name
      - kind
      properties:
        id:
          type: string
        name:
          type: string
        kind:
          type: string
          enum:
          - facility
          - hub
          - address
          - geo
        coords:
          type: object
          properties:
            lat:
              type: number
            lng:
              type: number
        attributes:
          type: object
          additionalProperties: true
        active:
          type: boolean
          default: true
    PathEdge:
      type: object
      required:
      - id
      - fromNodeId
      - toNodeId
      - distanceKm
      properties:
        id:
          type: string
        fromNodeId:
          type: string
        toNodeId:
          type: string
        distanceKm:
          type: number
        durationMin:
          type: number
        cost:
          type: number
        isClosed:
          type: boolean
          default: false
        attributes:
          type: object
          additionalProperties: true
    Carrier:
      type: object
      required:
      - id
      - name
      properties:
        id:
          type: string
        name:
          type: string
        modes:
          type: array
          items:
            type: string
            enum:
            - ground
            - air
            - horse
            - internal
        contactPartyId:
          type: string
        attributes:
          type: object
          additionalProperties: true
    DeliveryTask:
      type: object
      required:
      - id
      - partyId
      - fromNodeId
      - toNodeId
      properties:
        id:
          type: string
        orderRef:
          type: string
          description: SO/PO/Reservation id or composite
        partyId:
          type: string
        fromNodeId:
          type: string
        toNodeId:
          type: string
        window:
          type: object
          properties:
            start:
              type: string
              format: date-time
            end:
              type: string
              format: date-time
        status:
          type: string
          enum:
          - draft
          - planned
          - enroute
          - delivered
          - failed
          - cancelled
        attributes:
          type: object
          additionalProperties: true
    RoutePlan:
      type: object
      required:
      - id
      - objective
      - tasks
      properties:
        id:
          type: string
        objective:
          type: string
          enum:
          - shortest
          - fastest
          - cheapest
          - balanced
        constraints:
          type: object
          properties:
            closures:
              type: array
              items:
                type: string
                description: edge ids closed
            forbiddenNodes:
              type: array
              items:
                type: string
            maxHoursPerDriver:
              type: number
        carrierId:
          type: string
        tasks:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
        summary:
          type: object
          properties:
            distanceKm:
              type: number
            totalDurationMin:
              type: number
            totalCost:
              type: number
        status:
          type: string
          enum:
          - draft
          - planned
          - executed
          - archived
          default: draft
    ReservationsCheckConflictsRequest:
      type: object
      required:
      - resourceId
      - startsAt
      - endsAt
      properties:
        resourceId:
          type: string
          description: Resource ID
        startsAt:
          type: string
          format: date-time
          description: Reservation start time (ISO 8601)
        endsAt:
          type: string
          format: date-time
          description: Reservation end time (ISO 8601)
        excludeReservationId:
          type: string
          nullable: true
          description: Optional reservation ID to exclude from conflict check (for updates)
    ReservationsCheckConflictsResponse:
      type: object
      required:
      - conflicts
      properties:
        conflicts:
          type: array
          items:
            $ref: '#/components/schemas/Reservation'
          description: Array of overlapping reservations
    ResourceAvailabilityResponse:
      type: object
      required:
      - busy
      properties:
        busy:
          type: array
          items:
            $ref: '#/components/schemas/Reservation'
          description: List of reservations blocking availability in the requested time range
security:
- bearerAuth: []
paths:
  /reservation-holds/by-owner:
    get:
      tags:
      - Admin
      operationId: listReservationHoldsByOwner
      summary: List reservation holds by owner (internal)
      description: |
        Internal/operator endpoint to list reservation hold ledger records by owner.
        Useful for smokes and admin introspection. Prefer generic /objects endpoints for general CRUD.
      x-mbapp-permission: registration:read
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: ownerType
        in: query
        required: true
        schema:
          type: string
          enum: [registration]
        description: Owning entity type (currently registration)
      - name: ownerId
        in: query
        required: true
        schema:
          type: string
        description: Owner ID (e.g., registration id)
      - name: state
        in: query
        required: false
        schema:
          type: string
          enum: [held, confirmed, released, cancelled]
        description: Optional state filter
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Next'
      responses:
        '200':
          $ref: '#/components/responses/ListPage'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /objects/{type}:
    get:
      tags:
      - Objects
      operationId: listObjects
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/TypePath'
      - $ref: '#/components/parameters/Q'
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Next'
      - $ref: '#/components/parameters/Fields'
      - name: filter
        in: query
        schema:
          type: object
          additionalProperties:
            type: string
        style: form
        explode: true
        description: |
          Optional structured filters using dot notation (e.g., filter.soId=SO123&filter.itemId=ITEM456).
          Supported fields depend on object type. For backorderRequest:
          - filter.soId: Sales Order ID
          - filter.itemId: Inventory Item ID
          - filter.status: Backorder status (open, ignored, converted)
          - filter.preferredVendorId: Vendor ID
          Filters are combined with AND logic; combined with q search (substring).
      responses:
        '200':
          $ref: '#/components/responses/ListPage'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Get Objects by Type
    post:
      tags:
      - Objects
      operationId: createObject
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/TypePath'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnyObject'
      responses:
        '200':
          description: Created
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Post Objects
  /objects/{type}/list:
    get:
      tags:
      - Objects
      operationId: listObjectsExplicit
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/TypePath'
      - $ref: '#/components/parameters/Q'
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Next'
      - $ref: '#/components/parameters/Fields'
      responses:
        '200':
          $ref: '#/components/responses/ListPage'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Get Objects List
  /objects/{type}/search:
    get:
      tags:
      - Objects
      operationId: searchObjects
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/TypePath'
      - $ref: '#/components/parameters/Q'
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Next'
      - $ref: '#/components/parameters/Fields'
      responses:
        '200':
          $ref: '#/components/responses/ListPage'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Search Objects by Type
    post:
      tags:
      - Objects
      operationId: searchObjectsPost
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/TypePath'
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                q:
                  type: string
                  description: Full-text search query
                limit:
                  type: integer
                  default: 20
                  description: Results per page
                next:
                  type: string
                  nullable: true
                  description: Pagination cursor from previous response
                fields:
                  type: array
                  items:
                    type: string
                  description: Optional field projection
                status:
                  type: string
                  description: Filter by status (e.g., open, ignored, converted, fulfilled for backorderRequest)
                soId:
                  type: string
                  description: Filter by Sales Order ID (backorderRequest, salesOrder)
                itemId:
                  type: string
                  description: Filter by Inventory Item ID (backorderRequest, inventory)
                preferredVendorId:
                  type: string
                  description: Filter by Vendor ID (backorderRequest, product)
              description: |
                Search request body with optional filters.
                Filters are combined with AND logic and merged with q text search.
                For backorderRequest, supported filters include:
                - status: open, ignored, converted, fulfilled
                - soId: Sales Order ID
                - itemId: Inventory Item ID
                - preferredVendorId: Vendor ID
                Additional filters depend on object type.
      responses:
        '200':
          $ref: '#/components/responses/ListPage'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Search Objects by Type (POST)
  /objects/{type}/{id}:
    get:
      tags:
      - Objects
      operationId: getObject
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/TypePath'
      - $ref: '#/components/parameters/IdPath'
      - $ref: '#/components/parameters/Fields'
      responses:
        '200':
          description: OK
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      summary: Get Objects by Type and ID
    put:
      tags:
      - Objects
      operationId: updateObject
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/TypePath'
      - $ref: '#/components/parameters/IdPath'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnyObject'
      responses:
        '200':
          description: Updated (partial merge applied)
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      summary: Update Object (partial merge)
    delete:
      tags:
      - Objects
      operationId: deleteObject
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/TypePath'
      - $ref: '#/components/parameters/IdPath'
      responses:
        '204':
          description: Deleted
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      summary: Delete Objects
  /objects/party:batch:
    post:
      tags:
      - Objects
      operationId: batchGetParties
      summary: Batch get parties by IDs
      x-mbapp-permission: party:read
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - partyIds
              properties:
                partyIds:
                  type: array
                  items:
                    type: string
                  minItems: 1
                  maxItems: 100
                  description: Array of party IDs to fetch (server may cap to 100 per request)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Party'
                    description: Found parties (order may differ from input; missing IDs omitted)
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /auth/policy:
    get:
      tags:
      - Auth
      operationId: getPolicy
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Policy'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Get AUTH
  /views:
    get:
      tags:
      - Views
      operationId: listViews
      x-mbapp-permission: view:read
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/EntityType'
      - $ref: '#/components/parameters/Q'
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          $ref: '#/components/responses/ListPage'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      summary: List Views (Sprint III basic filtering + pagination)
    post:
      tags:
      - Views
      operationId: createView
      x-mbapp-permission: view:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/View'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/View'
        '400':
          $ref: '#/components/responses/ValidationErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Create a View
  /views/{id}:
    get:
      tags:
      - Views
      operationId: getView
      x-mbapp-permission: view:read
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/View'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
      summary: Get a View
    put:
      tags:
      - Views
      operationId: replaceView
      x-mbapp-permission: view:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/View'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/View'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      summary: Replace a View
    patch:
      tags:
      - Views
      operationId: updateView
      x-mbapp-permission: view:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
              $ref: '#/components/schemas/View'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/View'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      summary: Update a View (partial)
    delete:
      tags:
      - Views
      operationId: deleteView
      x-mbapp-permission: view:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '204':
          description: Deleted
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
      summary: Delete a View
  /workspaces:
    get:
      tags:
      - Workspaces
      operationId: listWorkspaces
      x-mbapp-permission: workspace:read
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: ownerId
        in: query
        schema:
          type: string
        description: Filter by owner party ID
      - name: shared
        in: query
        schema:
          type: boolean
        description: Filter by shared status
      - $ref: '#/components/parameters/Q'
      - $ref: '#/components/parameters/EntityType'
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Next'
      responses:
        '200':
          $ref: '#/components/responses/ListPage'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      summary: List Workspaces (Sprint III v1 lists user/tenant workspaces; full multi-tile composition in v2)
    post:
      tags:
      - Workspaces
      operationId: createWorkspace
      x-mbapp-permission: workspace:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Workspace'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        '400':
          $ref: '#/components/responses/ValidationErrorResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Create a Workspace
  /workspaces/{id}:
    get:
      tags:
      - Workspaces
      operationId: getWorkspace
      x-mbapp-permission: workspace:read
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
      summary: Get a Workspace
    put:
      tags:
      - Workspaces
      operationId: replaceWorkspace
      x-mbapp-permission: workspace:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Workspace'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      summary: Replace a Workspace
    patch:
      tags:
      - Workspaces
      operationId: updateWorkspace
      x-mbapp-permission: workspace:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      summary: Update a Workspace (partial)
    delete:
      tags:
      - Workspaces
      operationId: deleteWorkspace
      x-mbapp-permission: workspace:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '204':
          description: Deleted
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
      summary: Delete a Workspace
  /registrations:
    get:
      tags:
      - Registrations
      operationId: listRegistrations
      summary: List Registrations (Sprint IV v1 with filters + search)
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: eventId
        in: query
        schema:
          type: string
        description: Filter by event ID
      - name: partyId
        in: query
        schema:
          type: string
        description: Filter by party ID
      - name: status
        in: query
        schema:
          type: string
          enum: [draft, submitted, confirmed, cancelled]
        description: Filter by registration status
      - $ref: '#/components/parameters/Q'
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          $ref: '#/components/responses/ListPage'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      tags:
      - Registrations
      operationId: createRegistration
      summary: Create a Registration
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Registration'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Registration'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /registrations/{id}:
    get:
      tags:
      - Registrations
      operationId: getRegistration
      summary: Get a Registration
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Registration'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /registrations/{id}:cancel:
    post:
      tags:
      - Registrations
      operationId: cancelRegistration
      summary: Cancel a registration (operator)
      x-mbapp-permission: registration:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Updated registration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Registration'
        '400':
          description: Validation or state error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthorized, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not Found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /registrations/{id}:cancel-refund:
    post:
      tags:
      - Registrations
      operationId: cancelRefundRegistration
      summary: Cancel a confirmed registration and refund payment (operator)
      description: |
        Cancels a confirmed, paid registration and issues a refund.
        In simulate mode, returns a synthetic refund result. Returns the updated registration and optional refund info.
      x-mbapp-permission: registration:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Cancellation + refund result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CancelRefundResponse'
        '400':
          description: Validation or state error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthorized, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '404': { description: Not Found, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
    put:
      tags:
      - Registrations
      operationId: updateRegistration
      summary: Update a Registration
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Registration'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Registration'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      tags:
      - Registrations
      operationId: deleteRegistration
      summary: Delete a Registration
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '204':
          description: No Content
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /registrations/{id}:assign-stalls:
    post:
      tags:
      - Registrations
      operationId: assignStalls
      summary: Assign specific stalls to a registration (operator)
      description: |
        Converts a block stall hold (itemType=stall, resourceId=null) into specific granular assignments.
        Validates that stallIds length matches the block hold qty and that resources are available.
        Creates or updates ReservationHold records with resourceId set for each stall.
        Requires operator permission (registration:write).
      x-mbapp-permission: registration:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignStallsRequest'
      responses:
        '200':
          description: Stalls successfully assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignStallsResponse'
        '400':
          description: Validation error (qty mismatch, duplicates, invalid resource)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Registration or resource not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict (stall already assigned, registration not in correct state)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthorized, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /registrations/{id}:assign-rv-sites:
    post:
      tags:
      - Registrations
      operationId: assignRvSites
      summary: Assign specific RV sites to a registration (operator)
      description: |
        Converts a block RV hold (itemType=rv, resourceId=null) into specific granular assignments.
        Validates that rvSiteIds length matches the block hold qty and that resources are available.
        Creates or updates ReservationHold records with resourceId set for each RV site.
        Requires operator permission (registration:write).
      x-mbapp-permission: registration:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignRvSitesRequest'
      responses:
        '200':
          description: RV sites successfully assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignRvSitesResponse'
        '400':
          description: Validation error (qty mismatch, duplicates, invalid resource)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Registration or resource not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict (RV site already assigned, registration not in correct state)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthorized, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /registrations/{id}:assign-resources:
    post:
      tags:
      - Registrations
      operationId: assignResources
      summary: Assign discrete resources to a registration (operator)
      description: |
        Generalized endpoint to assign specific discrete resources (stalls, RV sites, or future types) to a registration.
        Converts a block resource hold (itemType per type, resourceId=null) into specific granular assignments.
        Validates that resourceIds length matches the block hold qty and that resources are available.
        Creates or updates ReservationHold records with resourceId set for each resource.
        Requires operator permission (registration:write).
      x-mbapp-permission: registration:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      - name: id
        in: path
        required: true
        schema:
          type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AssignResourcesRequest'
      responses:
        '200':
          description: Resources successfully assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AssignResourcesResponse'
        '400':
          description: Validation error (qty mismatch, duplicates, invalid resource type, unsupported itemType)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Registration or resource not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict (resource already assigned by another registration)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401': { description: Unauthorized, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
        '403': { description: Forbidden, content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } } }
  /registrations/{id}:public:
    get:
      tags:
      - Registrations
      - Public
      operationId: getPublicRegistrationStatus
      summary: Get public registration status (no auth) - Sprint AY
      description: |
        Public endpoint to read a registration's status using the public token issued at creation.
        Returns a safe subset only; excludes PII, fees, payment details, and publicTokenHash.
      security: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - in: header
        name: X-MBapp-Public-Token
        required: true
        schema:
          type: string
        description: Public token returned by POST /registrations:public
      responses:
        '200':
          description: Public-safe registration status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicRegistrationStatusResponse'
        '401':
          description: Invalid or missing public token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /registrations/{id}:public-resend:
    post:
      tags:
      - Registrations
      - Public
      operationId: resendPublicRegistrationMessages
      summary: Resend confirmation email/SMS using public token - Sprint BC
      description: |
        Public endpoint to request a resend of confirmation messages for a registration.
        Requires the same public token issued at creation. Server enforces bounds/rate limits and
        only exposes safe delivery fields (status, sentAt, provider, errorMessage).
      security: []
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      - in: header
        name: X-MBapp-Public-Token
        required: true
        schema:
          type: string
        description: Public token returned by POST /registrations:public
      - name: channel
        in: query
        schema:
          type: string
          enum: [email, sms, both]
          default: both
        description: Channel to resend (defaults to both)
      responses:
        '200':
          description: Resend attempt result (safe fields only)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicRegistrationResendResponse'
        '400':
          description: Validation error (invalid channel)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Invalid or missing public token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /events:public:
    get:
      tags:
      - Events
      - Public
      operationId: listPublicEvents
      summary: List public events (no auth required) - Sprint AU
      description: |
        Public endpoint for listing events. Intended for anonymous/guest users.
        Defaults to filtering for status=open events.
      security: []
      parameters:
      - name: status
        in: query
        schema:
          type: string
          enum: [draft, scheduled, open, closed, completed, cancelled, archived]
          default: open
        description: Filter by event status (defaults to open)
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: List of public events
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Event'
                  next:
                    type: string
                    nullable: true
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
  /registrations:public:
    post:
      tags:
      - Registrations
      - Public
      operationId: createPublicRegistration
      summary: Create a public registration (no auth required) - Sprint AU
      description: |
        Public endpoint for creating event registrations. Intended for anonymous/guest users.
        Returns a temporary publicToken for use in subsequent checkout.
      security: []
      parameters:
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PublicRegistrationRequest'
      responses:
        '201':
          description: Registration created with public token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicRegistrationResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '409':
          description: Event capacity exceeded
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: string
                    enum: [capacity_exceeded]
                  message:
                    type: string
                  details:
                    type: object
                    properties:
                      eventId:
                        type: string
                      capacity:
                        type: number
                      currentRegistrations:
                        type: number
  /registrations:cleanup-expired-holds:
    post:
      tags:
      - Registrations
      operationId: cleanupExpiredHolds
      summary: Expire submitted holds past TTL and release capacity (Sprint AV)
      description: Scans submitted registrations whose holdExpiresAt is in the past, cancels them, and decrements reservedCount for the linked event.
      x-mbapp-permission: registration:write
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: Cleanup completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  expiredCount:
                    type: integer
                    description: Number of registrations expired/cancelled
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /internal/jobs:run:
    post:
      tags:
      - Admin
      operationId: runBackgroundJobs
      summary: INTERNAL  Run background jobs on-demand (admin only)
      description: |
        Triggers bounded background jobs without a scheduler, for CI or admin use.
        Secured endpoint  requires admin permission and authentication. Not intended for public use.
      x-mbapp-permission: ops:jobs:run
      security:
      - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - jobType
              properties:
                jobType:
                  type: string
                  description: Job to run; use "all" to run both.
                  enum: [cleanup-expired-holds, retry-failed-messages, all]
                tenantId:
                  type: string
                  description: Optional tenant override for testing. Defaults to server env list.
                limit:
                  type: integer
                  minimum: 1
                  description: Optional limit override; otherwise server defaults are used per job.
      responses:
        '200':
          description: Jobs executed; per-tenant results returned
          content:
            application/json:
              schema:
                type: object
                properties:
                  results:
                    type: array
                    items:
                      type: object
                      required: [jobType, tenantId, ok, counts]
                      properties:
                        jobType:
                          type: string
                          enum: [cleanup-expired-holds, retry-failed-messages]
                        tenantId:
                          type: string
                        ok:
                          type: boolean
                        counts:
                          type: object
                          additionalProperties:
                            type: integer
                        errorMessage:
                          type: string
                          nullable: true
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /reservations:check-conflicts:
    post:
      tags:
      - Reservations
      operationId: checkReservationConflicts
      summary: Check for reservation conflicts within a time range
      description: |
        Check if a time slot is available for a resource by checking for overlapping reservations.
        Overlap rule: (aStart < bEnd) && (bStart < aEnd).
        Requires FEATURE_RESERVATIONS_ENABLED flag.
      security:
      - bearerAuth: []
      x-mb-flags:
        FEATURE_RESERVATIONS_ENABLED: true
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReservationsCheckConflictsRequest'
      responses:
        '200':
          description: Conflict check result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReservationsCheckConflictsResponse'
        '409':
          description: Conflict detected - time slot is occupied
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: string
                    enum: [conflict]
                  message:
                    type: string
                  details:
                    type: object
                    properties:
                      conflicts:
                        type: array
                        items:
                          type: string
                        description: IDs of conflicting reservations
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /resources/{id}/availability:
    get:
      tags:
      - Resources
      operationId: getResourceAvailability
      summary: Get resource availability within a time range
      description: |
        Query busy time slots (reservations) for a resource within a specified date range.
        Requires FEATURE_RESERVATIONS_ENABLED flag.
      security:
      - bearerAuth: []
      x-mb-flags:
        FEATURE_RESERVATIONS_ENABLED: true
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: id
        in: path
        required: true
        schema:
          type: string
        description: Resource ID
      - name: from
        in: query
        required: true
        schema:
          type: string
          format: date-time
        description: Start of time range (ISO 8601)
      - name: to
        in: query
        required: true
        schema:
          type: string
          format: date-time
        description: End of time range (ISO 8601)
      responses:
        '200':
          description: Resource availability for the requested time range
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ResourceAvailabilityResponse'
        '400':
          description: Validation error (missing/invalid from or to parameter)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '404':
          description: Resource not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /inventory/{id}/onhand:
    get:
      summary: Get computed counters for an inventory item
      x-mbapp-permission: inventory:read
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Computed counters (array with one element)
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/InventoryCounters'
  /inventory/{id}/onhand:by-location:
    get:
      tags:
      - Inventory
      summary: Get computed counters for an inventory item grouped by location
      x-mbapp-permission: inventory:read
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Computed counters grouped by location
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/InventoryOnHandByLocationItem'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  /inventory/onhand:batch:
    post:
      tags:
      - Inventory
      summary: Batch counters query (array)
      x-mbapp-permission: inventory:read
      parameters:
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - itemIds
              properties:
                itemIds:
                  type: array
                  items:
                    type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/InventoryCounters'
  /inventory/{id}/movements:
    get:
      summary: List movements for an inventory item
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      - in: query
        name: next
        schema:
          type: string
          nullable: true
      - in: query
        name: limit
        schema:
          type: integer
          default: 50
      - in: query
        name: sort
        schema:
          type: string
          enum:
          - asc
          - desc
          default: desc
      - in: query
        name: refId
        required: false
        schema:
          type: string
        description: Optional source document id (e.g., purchaseOrder id) to filter movements.
      - in: query
        name: poLineId
        required: false
        schema:
          type: string
        description: Optional purchase order line id to filter movements created by that line.
      responses:
        '200':
          description: Paged list of inventory movements (array)
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ListPageInventoryMovement'
                  - type: object
                    description: Backward-compatible; includes legacy `next` and optional `pageInfo`.
  /inventory/movements:
    get:
      summary: List inventory movements filtered by location
      parameters:
      - in: query
        name: locationId
        required: true
        schema:
          type: string
        description: Location id to filter movements by
      - in: query
        name: action
        required: false
        schema:
          type: string
          enum:
          - receive
          - reserve
          - commit
          - fulfill
          - adjust
          - release
          - putaway
          - cycle_count
        description: Optional movement action type to further filter results
      - in: query
        name: refId
        required: false
        schema:
          type: string
        description: Optional source document id (e.g., purchaseOrder id) to filter movements
      - in: query
        name: limit
        schema:
          type: integer
          default: 50
          maximum: 200
        description: Number of results per page (default 50, max 200)
      - in: query
        name: next
        schema:
          type: string
          nullable: true
        description: Opaque cursor for pagination (from previous response)
      - in: query
        name: sort
        schema:
          type: string
          enum:
          - asc
          - desc
          default: desc
        description: Sort order by timestamp (createdAt)
      responses:
        '200':
          description: Paged list of inventory movements at the location
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListMovementsByLocationResponse'
        '400':
          description: Bad Request (e.g., missing required locationId)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /inventory/{id}/adjust:
    post:
      summary: Adjust on-hand (creates movement)
      x-mbapp-permission: inventory:write
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/InventoryAdjustmentRequest'
      responses:
        '200':
          description: Adjustment recorded as an inventory movement
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InventoryMovement'
  /inventory/{id}:putaway:
    post:
      summary: Putaway inventory to location
      description: Creates a putaway movement; location trace only (no-op for onHand counters).
      x-mbapp-permission: inventory:write
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
        description: Inventory item id
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PutawayRequest'
      responses:
        '200':
          description: Putaway movement recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/InventoryMovement'
        '400':
          description: BadRequest (e.g., qty <= 0 or missing toLocationId)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /inventory/{id}:cycle-count:
    post:
      summary: Reconcile on-hand via physical count
      description: |
        Performs a cycle count reconciliation. Computes delta = countedQty - currentOnHand.
        If delta = 0, returns early without writing a movement.
        Otherwise, creates a cycle_count movement with qty=delta to correct the onHand.
      x-mbapp-permission: inventory:adjust
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
        description: Inventory item id
      - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CycleCountRequest'
      responses:
        '200':
          description: |
            Cycle count completed. If delta=0, no movement is written and message='no change'.
            Otherwise, a cycle_count movement with qty=delta is recorded.
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  priorOnHand:
                    type: number
                    description: OnHand before count
                  countedQty:
                    type: number
                    description: Physical count quantity
                  delta:
                    type: number
                    description: Difference (countedQty - priorOnHand)
                  message:
                    type: string
                    nullable: true
                    description: 'If delta=0: "no change", else null'
                  movementId:
                    type: string
                    nullable: true
                    description: Movement id (null if delta=0)
                  movement:
                    $ref: '#/components/schemas/InventoryMovement'
                    nullable: true
                    description: Created movement (null if delta=0)
        '400':
          description: BadRequest (e.g., countedQty < 0)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /purchasing/po/{id}:submit:
    post:
      summary: Submit purchase order
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseOrder' } } }
        '409':
          description: Guardrail violation (e.g., invalid status transition)
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /purchasing/po/{id}:approve:
    post:
      x-mbapp-permission: purchase:approve
      summary: Approve purchase order
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseOrder' } } }
        '409':
          description: Only submitted can approve
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /purchasing/po/{id}:patch-lines:
    post:
      summary: Apply patch operations to purchase order lines (draft-only)
      x-mbapp-permission: purchase:write
      description: |
        Patch lines for draft purchase orders only. Non-draft states reject with 409 (PO_NOT_EDITABLE).
        
        Supports minimal patch operations:
        - **upsert**: Create or update line by `id` (existing) or `cid` (new). Server assigns stable ids (L1, L2, ...) for new lines.
        - **remove**: Delete line by `id` or `cid`.
        
        **Error Codes:**
        - 400: Invalid ops (missing op, invalid cid format, cid starts with reserved L\d+ pattern)
        - 404: Purchase order not found
        - 409: PO_NOT_EDITABLE (non-draft status), or validation error (invalid ops format)
      operationId: patchPurchaseOrderLines
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
          description: Purchase order id
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PatchLinesRequest' }
      responses:
        '200':
          description: Updated purchase order with normalized lines (server-assigned ids)
          content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseOrder' } } }
        '400':
          description: Bad request (invalid ops, missing required fields)
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
        '404':
          description: Purchase order not found
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
        '409':
          description: Conflict or guardrail violation (e.g., PO_NOT_EDITABLE)
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /purchasing/po/{id}:receive:
    post:
      x-mbapp-permission: purchase:receive
      summary: Receive against purchase order lines
      description: Allowed from **approved** or **partially-received**. Over-receive returns 409. \
        **Idempotency:** provide an `Idempotency-Key` header to safely retry the same receive request; \
        duplicates with the same key will return the current PO state without double-applying movements. \
        Requests may also be deduplicated by payload signature.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PurchaseOrderReceiveRequest' }
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseOrder' } } }
        '409':
          description: Over-receive or invalid status
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /purchasing/po/{id}:cancel:
    post:
      x-mbapp-permission: purchase:cancel
      summary: Cancel purchase order
      description: Allowed from **draft**/**submitted**. Returns 409 otherwise.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseOrder' } } }
        '409':
          description: Guardrail violation
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /purchasing/po/{id}:close:
    post:
      x-mbapp-permission: purchase:close
      summary: Close purchase order
      description: Allowed from **fulfilled**. Returns 409 otherwise.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseOrder' } } }
        '409':
          description: Guardrail violation
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  # (Optional) Deprecated single-line receive helper
  /purchase-orders/{id}/receive-line:
    post:
      deprecated: true
      tags: [Purchasing]
      summary: Receive a specific PO line
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id, qty]
              properties:
                id:       { type: string, description: "Canonical line id (preferred). Server-assigned `L{n}` pattern." }
                lineId:   { type: string, nullable: true, deprecated: true, description: "Alias for id (compatibility; will be removed after transition)." }
                qty:      { type: number, minimum: 1 }
                lot:      { type: string, nullable: true }
                location: { type: string, nullable: true }
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/PurchaseOrder' } } }
  /purchasing/suggest-po:
    post:
      x-mbapp-permission: purchase:write
      tags: [Purchasing]
      summary: Build a PO draft from backorder requests
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                requests:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [backorderRequestId]
                    properties:
                      backorderRequestId: { type: string }
                vendorId: { type: string, nullable: true }
      responses:
        "200":
          description: One or more purchase order drafts (not persisted)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuggestPoResponse'

  /purchasing/po:create-from-suggestion:
    post:
      x-mbapp-permission: purchase:write
      summary: Persist purchase order draft(s) created from suggestion
      operationId: createPoFromSuggestion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  required: [draft]
                  properties:
                    draft:
                      $ref: '#/components/schemas/PurchaseOrder'
                - type: object
                  required: [drafts]
                  properties:
                    drafts:
                      type: array
                      items: { $ref: '#/components/schemas/PurchaseOrder' }
      responses:
        '200':
          description: Created id(s)
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    description: Convenience when exactly one was created
                  ids:
                    type: array
                    items: { type: string }

  /objects/backorderRequest/{id}:ignore:
    post:
      x-mbapp-permission: objects:write
      tags: [Objects]
      summary: Mark a BackorderRequest as ignored
      parameters:
      - name: id
        in: path
        required: true
        schema: { type: string }
      responses:
        "200":
          description: Updated BackorderRequest
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BackorderRequest' }

  /objects/backorderRequest/{id}:convert:
    post:
      x-mbapp-permission: objects:write
      tags: [Objects]
      summary: Mark a BackorderRequest as converted (attached to a PO)
      parameters:
      - name: id
        in: path
        required: true
        schema: { type: string }
      responses:
        "200":
          description: Updated BackorderRequest
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BackorderRequest' }  
  /sales/so/{id}:submit:
    post:
      summary: Submit sales order
      x-mbapp-permission: sales:write
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesOrder' } } }

  /sales/so/{id}:commit:
    post:
      summary: Commit/allocate inventory for a sales order
      x-mbapp-permission: sales:commit
      description: |
        Default is non-strict (200 with `shortages[]` when partially available).
        Set `?strict=1` or `{ "strict": true }` to require full availability (409 on shortage).
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - in: query
          name: strict
          schema: { type: integer, enum: [0, 1] }
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SalesCommitRequest' }
      responses:
        '200':
          description: OK (may include `shortages[]` when non-strict)
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesCommitResponse' } } }
        '409':
          description: Insufficient availability in strict mode
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesCommitResponse' } } }

  /sales/so/{id}:reserve:
    post:
      summary: Reserve specific line quantities on a sales order
      x-mbapp-permission: sales:reserve
      description: Valid from **submitted** or **committed**.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SalesOrderReserveRequest' }
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesOrder' } } }
        '409':
          description: Insufficient availability
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  shortages:
                    type: array
                    items:
                      type: object
                      properties:
                        lineId:    { type: string }
                        itemId:    { type: string }
                        requested: { type: number }
                        available: { type: number }

  /sales/so/{id}:release:
    post:
      summary: Release previously reserved quantity
      x-mbapp-permission: sales:reserve
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/SalesOrderReleaseRequest' }
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesOrder' } } }
        '409':
          description: Guardrail violation
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /sales/so/{id}:patch-lines:
    post:
      summary: Apply patch operations to sales order lines (draft/submitted/committed)
      x-mbapp-permission: sales:write
      description: |
        Patch lines while the sales order is editable (draft, submitted, or committed). Non-editable states reject with 409 (SO_NOT_EDITABLE).
        
        Supports minimal patch operations:
        - **upsert**: Create or update line by `id` (existing) or `cid` (new). Server assigns stable ids (L1, L2, ...) for new lines.
        - **remove**: Delete line by `id` or `cid`.
        
        **Error Codes:**
        - 400: Invalid ops (missing op, invalid cid format, cid starts with reserved L\d+ pattern)
        - 404: Sales order not found
        - 409: SO_NOT_EDITABLE (non-editable status), or validation error (invalid ops format)
      operationId: patchSalesOrderLines
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
          description: Sales order id
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PatchLinesRequest' }
      responses:
        '200':
          description: Updated sales order with normalized lines (server-assigned ids)
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesOrder' } } }
        '400':
          description: Bad request (invalid ops, missing required fields)
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
        '404':
          description: Sales order not found
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }
        '409':
          description: Conflict or guardrail violation (e.g., SO_NOT_EDITABLE)
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /sales/so/{id}:fulfill:
    post:
      summary: Fulfill (ship/pick) SO lines
      x-mbapp-permission: sales:fulfill
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                lines:
                  type: array
                  minItems: 1
                  items:
                    type: object
                    required: [id, deltaQty]
                    properties:
                      id:         { type: string, description: "Canonical line id (preferred). Server-assigned `L{n}` pattern." }
                      lineId:     { type: string, nullable: true, deprecated: true, description: "Alias for id (compatibility; will be removed after transition)." }
                      deltaQty:   { type: number, minimum: 1, description: Quantity shipped/picked }
                      locationId: { type: string }
                      lot:        { type: string }
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesOrder' } } }
        '409':
          description: Guardrail violation (over-fulfill or invalid status)
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /sales/so/{id}:cancel:
    post:
      summary: Cancel sales order
      x-mbapp-permission: sales:cancel
      description: Blocked when **net reservations > 0** or **any fulfillments** exist.
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesOrder' } } }
        '409':
          description: Guardrail violation
          content: { application/json: { schema: { $ref: '#/components/schemas/Error' } } }

  /sales/so/{id}:close:
    post:
      summary: Close sales order (allowed from fulfilled)
      x-mbapp-permission: sales:close
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
        - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesOrder' } } }

  # Deprecated single-line fulfill (keep if you still expose it)
  /sales-orders/{id}/fulfill-line:
    post:
      deprecated: true
      description: Use `POST /sales/so/{id}:fulfill` instead.
      tags: [Sales]
      summary: Fulfill a specific SO line
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [id, qty]
              properties:
                id:   { type: string, description: "Canonical line id (preferred). Server-assigned `L{n}` pattern." }
                lineId: { type: string, nullable: true, deprecated: true, description: "Alias for id (compatibility; will be removed after transition)." }
                qty:    { type: number }
                lot:    { type: string, nullable: true }
                location: { type: string, nullable: true }
      responses:
        '200':
          description: OK
          content: { application/json: { schema: { $ref: '#/components/schemas/SalesOrder' } } }
  /routing/graph:
    post:
      operationId: upsertRoutingGraph
      summary: Upsert nodes and edges for routing (idempotent)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                nodes:
                  type: array
                  items:
                    $ref: '#/components/schemas/LocationNode'
                edges:
                  type: array
                  items:
                    $ref: '#/components/schemas/PathEdge'
      responses:
        '200':
          description: OK
  /routing/plan:
    post:
      operationId: createRoutePlan
      summary: Create a route plan from tasks and objective
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                objective:
                  type: string
                  enum:
                  - shortest
                  - fastest
                  - cheapest
                  - balanced
                constraints:
                  $ref: '#/components/schemas/RoutePlan/properties/constraints'
                carrierId:
                  type: string
                tasks:
                  type: array
                  items:
                    $ref: '#/components/schemas/DeliveryTask'
                graph:
                  type: object
                  properties:
                    nodes:
                      type: array
                      items:
                        $ref: '#/components/schemas/LocationNode'
                    edges:
                      type: array
                      items:
                        $ref: '#/components/schemas/PathEdge'
      responses:
        '200':
          description: Created plan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoutePlan'
  /routing/plan/{id}:
    get:
      operationId: getRoutePlan
      summary: Get a route plan by id
      parameters:
      - name: id
        in: path
        required: true
        schema:
          type: string
      responses:
        '200':
          description: Route plan
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoutePlan'
  /events/registration/{id}:cancel:
    post:
      summary: Cancel a registration
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: Updated registration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Registration'
  /events/registration/{id}:checkin:
    post:
      summary: Check in a registration
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: Updated registration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Registration'
  /events/registration/{id}:checkout:
    post:
      tags:
      - Registrations
      - Public
      operationId: checkoutRegistration
      summary: Create Stripe PaymentIntent for registration - Sprint AU
      description: |
        Public endpoint to initiate payment for a registration.
        Requires X-MBapp-Public-Token header (obtained from POST /registrations:public).
        Creates or retrieves a Stripe PaymentIntent and returns the clientSecret for frontend payment confirmation.
        Idempotent via Idempotency-Key header.
      security: []
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
        description: Registration ID
      - $ref: '#/components/parameters/IdempotencyKey'
      - in: header
        name: X-MBapp-Public-Token
        required: true
        schema:
          type: string
        description: Public token from registration creation
      responses:
        '200':
          description: PaymentIntent created or retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentIntentResponse'
        '400':
          description: Validation error (invalid token or missing fields)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          description: Invalid or expired public token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Registration not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Registration already confirmed or cancelled
          content:
            application/json:
              schema:
                type: object
                properties:
                  code:
                    type: string
                    enum: [invalid_status]
                  message:
                    type: string
                  details:
                    type: object
                    properties:
                      currentStatus:
                        type: string
  /messages/{id}:retry:
    post:
      tags:
      - Messages
      operationId: retryMessage
      summary: Retry a failed message delivery
      description: |
        Retries sending a message that previously failed.
        Only messages with status=failed can be retried.
        Increments retryCount and resets status to queued for re-delivery.
      security:
      - bearerAuth: []
      x-mbapp-permission: message:write
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - in: path
        name: id
        required: true
        schema:
          type: string
        description: Message ID
      - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: Message queued for retry
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
        '400':
          description: Message not retryable (status not failed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
  /messages:
    get:
      tags:
      - Messages
      operationId: listMessages
      summary: List Messages
      description: List messages with optional filters and cursor-based pagination.
      security:
      - bearerAuth: []
      x-mbapp-permission: message:read
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: status
        in: query
        schema:
          type: string
          enum: [queued, sending, sent, failed, cancelled]
        description: Optional status filter
      - name: channel
        in: query
        schema:
          type: string
          enum: [email, sms, push]
        description: Optional channel filter
      - name: provider
        in: query
        schema:
          type: string
        description: Optional provider filter (e.g., postmark, twilio)
      - name: to
        in: query
        schema:
          type: string
        description: Optional recipient filter
      - $ref: '#/components/parameters/Limit'
      - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/Message'
                  next:
                    type: string
                    nullable: true
                required:
                - items
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /messages:retry-failed:
    post:
      tags:
      - Messages
      operationId: retryFailedMessages
      summary: Retry failed messages in batch
      description: Retry up to the specified limit of failed messages, optionally filtered by channel or provider.
      security:
      - bearerAuth: []
      x-mbapp-permission: message:write
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: limit
        in: query
        schema:
          type: integer
          format: int32
          minimum: 1
          maximum: 200
          default: 25
        description: Maximum number of failed messages to retry (bounded server-side)
      - name: channel
        in: query
        schema:
          type: string
          enum: [email, sms, push]
        description: Optional channel filter when retrying failed messages
      - name: provider
        in: query
        schema:
          type: string
        description: Optional provider filter when retrying failed messages
      - $ref: '#/components/parameters/Cursor'
      responses:
        '200':
          description: Batch retry attempt results
          content:
            application/json:
              schema:
                type: object
                properties:
                  items:
                    type: array
                    items:
                      $ref: '#/components/schemas/MessageRetryResult'
                  next:
                    type: string
                    nullable: true
                required:
                - items
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
  /webhooks/stripe:
    post:
      tags:
      - Webhooks
      - Public
      operationId: stripeWebhook
      summary: Stripe webhook handler - Sprint AU
      description: |
        Public endpoint for Stripe webhook events (checkout.session.completed, payment_intent.*, etc.).
        Validates webhook signature using STRIPE_WEBHOOK_SECRET.
        Idempotent: processes each event exactly once based on event ID.
        On payment_intent.succeeded, creates a confirmation Message (email) for the registration (simulate mode allowed).
      security: []
      parameters:
      - in: header
        name: Stripe-Signature
        required: true
        schema:
          type: string
        description: Stripe webhook signature for verification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              description: Stripe event object (signature validated server-side)
              properties:
                id:
                  type: string
                  description: Stripe event ID
                type:
                  type: string
                  description: Event type (e.g., checkout.session.completed)
                data:
                  type: object
                  description: Event data payload
      responses:
        '200':
          description: Webhook processed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                    example: true
        '400':
          description: Invalid signature or malformed payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: invalid_signature
  /resources/reservation/{id}:cancel:
    post:
      summary: Cancel a reservation
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: Updated reservation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reservation'
  /resources/reservation/{id}:start:
    post:
      summary: Start a reservation (resource now in use)
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: Updated reservation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reservation'
  /resources/reservation/{id}:end:
    post:
      summary: End a reservation (resource returned)
      parameters:
      - in: path
        name: id
        required: true
        schema:
          type: string
      - $ref: '#/components/parameters/IdempotencyKey'
      responses:
        '200':
          description: Updated reservation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reservation'
  /epc/resolve:
    get:
      summary: Resolve EPC to item
      parameters:
      - in: query
        name: epc
        required: true
        schema:
          type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  itemId:
                    type: string
                  status:
                    type: string
        '404':
          description: Not found
  /scanner/sessions:
    post:
      summary: Start/stop a scanner session
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                op:
                  type: string
                  enum:
                  - start
                  - stop
                sessionId:
                  type: string
                  description: Required for stop
                workspaceId:
                  type: string
                  nullable: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScannerSession'
  /scanner/actions:
    post:
      summary: Record a scanner action (pick/receive/count/move)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
              - action
              - epc
              properties:
                action:
                  type: string
                  enum:
                  - pick
                  - receive
                  - count
                  - move
                epc:
                  type: string
                qty:
                  type: number
                  default: 1
                soId:
                  type: string
                lineId:
                  type: string
                fromLocationId:
                  type: string
                toLocationId:
                  type: string
      responses:
        '200':
          description: Recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScannerAction'
        '409':
          description: Guardrail violation
  /scanner/simulate:
    post:
      summary: Dev only - generate EPCs bound to itemIds
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                count:
                  type: integer
                  default: 10
                  minimum: 1
                  maximum: 1000
                itemId:
                  type: string
                  nullable: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  created:
                    type: integer
  /admin/audit:
    get:
      tags:
      - Admin
      operationId: listAudit
      security:
      - bearerAuth: []
      parameters:
      - $ref: '#/components/parameters/TenantHeader'
      - name: since
        in: query
        schema:
          type: string
          format: date-time
      - name: limit
        in: query
        schema:
          type: integer
          default: 100
      responses:
        '200':
          description: OK
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      summary: Admin Audit
